<!DOCTYPE html>
<html>
<head>
    <title>The Cruise Game - AI Enhanced</title>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            background: #333;
            font-family: Arial, sans-serif;
        }

        #gameContainer {
            position: relative;
            width: 1600px;
            height: 1200px;
            margin: 20px auto;
            background: #87CEEB;
            border: 2px solid #000;
            overflow: auto;
        }

        .character {
            position: absolute;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 12px;
            color: white;
            text-align: center;
            z-index: 2;
            transition: all 0.3s ease;
        }

        .nametag {
            position: absolute;
            bottom: -20px;
            width: 100%;
            text-align: center;
            font-size: 10px;
            color: black;
            background: rgba(255, 255, 255, 0.7);
            padding: 2px;
            border-radius: 3px;
        }

        .building {
            position: absolute;
            background: #666;
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            font-size: 12px;
            z-index: 1;
        }

        .house { background: #8B4513; }
        .school { background: #4A90E2; }

        #dialogBox {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 15px;
            border-radius: 5px;
            width: 400px;
            display: none;
            z-index: 1000;
        }

        #inputBox {
            width: 100%;
            padding: 5px;
            margin-top: 10px;
            border: none;
            border-radius: 3px;
        }

        .action-box {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.8);
            padding: 10px;
            border-radius: 5px;
            color: white;
        }
    </style>
</head>
<body>
    <div id="gameContainer">
        <div id="dialogBox">
            <div id="dialogText"></div>
            <input type="text" id="inputBox" placeholder="Type your message...">
        </div>
        <div class="action-box">
            <input type="text" id="actionInput" placeholder="Describe your action...">
            <button onclick="processAction()">Do Action</button>
        </div>
    </div>

    <script>
    // ModernBERT API Integration
    const API = (function() {
        const config = {
            token: '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',
            model: 'answerdotai/ModernBERT-base'
        };

        async function query(data) {
            try {
                const response = await fetch(
                    `https://api-inference.huggingface.co/models/${config.model}`,
                    {
                        headers: {
                            Authorization: `Bearer ${config.token}`,
                            "Content-Type": "application/json",
                        },
                        method: "POST",
                        body: JSON.stringify(data),
                    }
                );
                const result = await response.json();
                return result;
            } catch (error) {
                console.error("API Error:", error);
                return { error: error.message };
            }
        }

        async function testAPI() {
            try {
                const response = await query({"inputs": "Hello, test connection."});
                console.log("API Test Response:", response);
                return !response.error;
            } catch (error) {
                console.error("API Test Failed:", error);
                return false;
            }
        }

        return {
            query,
            testAPI
        };
    })();

    // Game State
    const gameState = {
        characters: [
            { name: "Jacob", age: 14, color: "#FFD700", x: 800, y: 600, isPlayer: true },
            { name: "Emily", age: 15, color: "#FF69B4", x: 400, y: 400 },
            { name: "Dan", age: 17, color: "#4169E1", x: 1200, y: 300 },
            { name: "Ash", age: 16, color: "#9370DB", x: 600, y: 800 }
        ],
        buildings: [
            { name: "Family House", type: "house", x: 1000, y: 900, width: 150, height: 120 },
            { name: "High School", type: "school", x: 200, y: 200, width: 300, height: 200 },
            { name: "Shop", type: "commercial", x: 800, y: 200, width: 100, height: 80 }
        ],
        player: null,
        currentInteraction: null
    };

    // Initialize Game
    function initGame() {
        createGameElements();
        
        // Test API connection
        API.testAPI().then(success => {
            if (success) {
                console.log("API connected successfully!");
            } else {
                console.error("Failed to connect to API");
            }
        });

        // Set up game loop
        setInterval(gameLoop, 1000/60);
    }

    function createGameElements() {
        // Create buildings
        gameState.buildings.forEach(building => {
            const buildingElement = document.createElement('div');
            buildingElement.className = `building ${building.type}`;
            buildingElement.style.left = building.x + 'px';
            buildingElement.style.top = building.y + 'px';
            buildingElement.style.width = building.width + 'px';
            buildingElement.style.height = building.height + 'px';
            buildingElement.innerHTML = building.name;
            gameContainer.appendChild(buildingElement);
        });

        // Create characters
        gameState.characters.forEach(char => {
            const charElement = document.createElement('div');
            charElement.className = 'character';
            charElement.style.backgroundColor = char.color;
            charElement.style.left = char.x + 'px';
            charElement.style.top = char.y + 'px';
            
            const nametag = document.createElement('div');
            nametag.className = 'nametag';
            nametag.textContent = `${char.name} (${char.age})`;
            charElement.appendChild(nametag);

            if (char.isPlayer) {
                charElement.classList.add('player');
                gameState.player = charElement;
            }

            gameContainer.appendChild(charElement);
        });
    }

    // Movement Controls
    const keys = {};
    document.addEventListener('keydown', e => keys[e.key.toLowerCase()] = true);
    document.addEventListener('keyup', e => keys[e.key.toLowerCase()] = false);

    function movePlayer() {
        if (!gameState.player) return;

        const speed = 5;
        const playerChar = gameState.characters.find(c => c.isPlayer);
        
        if (keys['w']) playerChar.y -= speed;
        if (keys['s']) playerChar.y += speed;
        if (keys['a']) playerChar.x -= speed;
        if (keys['d']) playerChar.x += speed;

        // Keep player within bounds
        playerChar.x = Math.max(0, Math.min(1570, playerChar.x));
        playerChar.y = Math.max(0, Math.min(1170, playerChar.y));

        gameState.player.style.left = playerChar.x + 'px';
        gameState.player.style.top = playerChar.y + 'px';
    }

    // Dialog System with ModernBERT Integration
    const dialogBox = document.getElementById('dialogBox');
    const dialogText = document.getElementById('dialogText');
    const inputBox = document.getElementById('inputBox');

    async function handleDialog(message) {
        try {
            const response = await API.query({
                "inputs": message
            });
            
            if (response.error) {
                return "Sorry, I couldn't process that right now.";
            }
            
            // Handle ModernBERT response format
            return Array.isArray(response) ? response[0].generated_text : response.generated_text;
        } catch (error) {
            console.error("Dialog error:", error);
            return "Sorry, there was an error processing your message.";
        }
    }

    inputBox.addEventListener('keypress', async (e) => {
        if (e.key === 'Enter' && gameState.currentInteraction) {
            const message = inputBox.value.trim();
            if (message) {
                const response = await handleDialog(message);
                dialogText.innerHTML += `<br>You: ${message}<br>${gameState.currentInteraction.name}: ${response}`;
                inputBox.value = '';
            }
        }
    });

    function showDialog(text) {
        dialogBox.style.display = 'block';
        dialogText.innerHTML = text;
        inputBox.focus();
    }

    function hideDialog() {
        dialogBox.style.display = 'none';
        dialogText.innerHTML = '';
        inputBox.value = '';
        gameState.currentInteraction = null;
    }

    // Action Processing
    async function processAction() {
        const actionInput = document.getElementById('actionInput');
        const action = actionInput.value.trim();
        
        if (action) {
            try {
                const response = await API.query({
                    "inputs": `Action: ${action}`
                });
                
                showDialog(`Action: ${action}\nResult: ${response[0].generated_text}`);
                actionInput.value = '';
            } catch (error) {
                console.error('Failed to process action:', error);
                showDialog('Could not process action at this time.');
            }
        }
    }

    // Interaction Check
    function checkInteractions() {
        const playerChar = gameState.characters.find(c => c.isPlayer);
        let foundInteraction = false;
        
        gameState.characters.forEach(char => {
            if (!char.isPlayer) {
                const distance = Math.hypot(playerChar.x - char.x, playerChar.y - char.y);
                
                if (distance < 50) {
                    foundInteraction = true;
                    if (!gameState.currentInteraction) {
                        gameState.currentInteraction = char;
                        showDialog(`Talking to ${char.name}. What would you like to say?`);
                    }
                }
            }
        });

        if (!foundInteraction && gameState.currentInteraction) {
            hideDialog();
        }
    }

    // Game Loop
    function gameLoop() {
        movePlayer();
        checkInteractions();
    }

    // Start the game
    window.onload = initGame;
    </script>
</body>
</html>
